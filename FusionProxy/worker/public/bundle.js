(()=>{"use strict";const e=globalThis.fetch,t=globalThis.WebSocket,o=globalThis.Request,n=globalThis.Response,s={prototype:{send:t.prototype.send},CLOSED:t.CLOSED,CLOSING:t.CLOSING,CONNECTING:t.CONNECTING,OPEN:t.OPEN},r=[101,204,205,304],a=[301,302,303,307,308];class i extends Error{status;body;constructor(e,t){super(t.message||t.code),this.status=e,this.body=t}}class c{base;constructor(e,t){this.base=new URL(`./v${e}/`,t)}}function l(e,t){const o=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(o>>16)<<16|65535&o}function h(e,t,o,n,s,r){return l((a=l(l(t,e),l(n,r)))<<(i=s)|a>>>32-i,o);var a,i}function d(e,t,o,n,s,r,a){return h(t&o|~t&n,e,t,s,r,a)}function u(e,t,o,n,s,r,a){return h(t&n|o&~n,e,t,s,r,a)}function f(e,t,o,n,s,r,a){return h(t^o^n,e,t,s,r,a)}function w(e,t,o,n,s,r,a){return h(o^(t|~n),e,t,s,r,a)}function p(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let o=1732584193,n=-271733879,s=-1732584194,r=271733878;for(let t=0;t<e.length;t+=16){const a=o,i=n,c=s,h=r;o=d(o,n,s,r,e[t],7,-680876936),r=d(r,o,n,s,e[t+1],12,-389564586),s=d(s,r,o,n,e[t+2],17,606105819),n=d(n,s,r,o,e[t+3],22,-1044525330),o=d(o,n,s,r,e[t+4],7,-176418897),r=d(r,o,n,s,e[t+5],12,1200080426),s=d(s,r,o,n,e[t+6],17,-1473231341),n=d(n,s,r,o,e[t+7],22,-45705983),o=d(o,n,s,r,e[t+8],7,1770035416),r=d(r,o,n,s,e[t+9],12,-1958414417),s=d(s,r,o,n,e[t+10],17,-42063),n=d(n,s,r,o,e[t+11],22,-1990404162),o=d(o,n,s,r,e[t+12],7,1804603682),r=d(r,o,n,s,e[t+13],12,-40341101),s=d(s,r,o,n,e[t+14],17,-1502002290),n=d(n,s,r,o,e[t+15],22,1236535329),o=u(o,n,s,r,e[t+1],5,-165796510),r=u(r,o,n,s,e[t+6],9,-1069501632),s=u(s,r,o,n,e[t+11],14,643717713),n=u(n,s,r,o,e[t],20,-373897302),o=u(o,n,s,r,e[t+5],5,-701558691),r=u(r,o,n,s,e[t+10],9,38016083),s=u(s,r,o,n,e[t+15],14,-660478335),n=u(n,s,r,o,e[t+4],20,-405537848),o=u(o,n,s,r,e[t+9],5,568446438),r=u(r,o,n,s,e[t+14],9,-1019803690),s=u(s,r,o,n,e[t+3],14,-187363961),n=u(n,s,r,o,e[t+8],20,1163531501),o=u(o,n,s,r,e[t+13],5,-1444681467),r=u(r,o,n,s,e[t+2],9,-51403784),s=u(s,r,o,n,e[t+7],14,1735328473),n=u(n,s,r,o,e[t+12],20,-1926607734),o=f(o,n,s,r,e[t+5],4,-378558),r=f(r,o,n,s,e[t+8],11,-2022574463),s=f(s,r,o,n,e[t+11],16,1839030562),n=f(n,s,r,o,e[t+14],23,-35309556),o=f(o,n,s,r,e[t+1],4,-1530992060),r=f(r,o,n,s,e[t+4],11,1272893353),s=f(s,r,o,n,e[t+7],16,-155497632),n=f(n,s,r,o,e[t+10],23,-1094730640),o=f(o,n,s,r,e[t+13],4,681279174),r=f(r,o,n,s,e[t],11,-358537222),s=f(s,r,o,n,e[t+3],16,-722521979),n=f(n,s,r,o,e[t+6],23,76029189),o=f(o,n,s,r,e[t+9],4,-640364487),r=f(r,o,n,s,e[t+12],11,-421815835),s=f(s,r,o,n,e[t+15],16,530742520),n=f(n,s,r,o,e[t+2],23,-995338651),o=w(o,n,s,r,e[t],6,-198630844),r=w(r,o,n,s,e[t+7],10,1126891415),s=w(s,r,o,n,e[t+14],15,-1416354905),n=w(n,s,r,o,e[t+5],21,-57434055),o=w(o,n,s,r,e[t+12],6,1700485571),r=w(r,o,n,s,e[t+3],10,-1894986606),s=w(s,r,o,n,e[t+10],15,-1051523),n=w(n,s,r,o,e[t+1],21,-2054922799),o=w(o,n,s,r,e[t+8],6,1873313359),r=w(r,o,n,s,e[t+15],10,-30611744),s=w(s,r,o,n,e[t+6],15,-1560198380),n=w(n,s,r,o,e[t+13],21,1309151649),o=w(o,n,s,r,e[t+4],6,-145523070),r=w(r,o,n,s,e[t+11],10,-1120210379),s=w(s,r,o,n,e[t+2],15,718787259),n=w(n,s,r,o,e[t+9],21,-343485551),o=l(o,a),n=l(n,i),s=l(s,c),r=l(r,h)}return[o,n,s,r]}function g(e){let t="";const o=32*e.length;for(let n=0;n<o;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function b(e){const t=[],o=e.length>>2;for(let e=0;e<o;e+=1)t[e]=0;const n=8*e.length;for(let o=0;o<n;o+=8)t[o>>5]|=(255&e.charCodeAt(o/8))<<o%32;return t}function m(e){const t="0123456789abcdef";let o="";for(let n=0;n<e.length;n+=1){const s=e.charCodeAt(n);o+=t.charAt(s>>>4&15)+t.charAt(15&s)}return o}function y(e){return unescape(encodeURIComponent(e))}function E(e){return function(e){return g(p(b(e),8*e.length))}(y(e))}function S(e,t){return function(e,t){let o=b(e);const n=[],s=[];o.length>16&&(o=p(o,8*e.length));for(let e=0;e<16;e+=1)n[e]=909522486^o[e],s[e]=1549556828^o[e];const r=p(n.concat(b(t)),512+8*t.length);return g(p(s.concat(r),640))}(y(e),y(t))}const k=3072;function C(e){for(let t=0;t<e.length;t++){const o=e[t];if(!"!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~".includes(o))return!1}return!0}const O=[["v3",class extends c{ws;http;constructor(e){super(3,e),this.ws=new URL(this.base),this.http=new URL(this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}connect(e,o,n,r,a){const i=new t(this.ws),c=()=>{i.removeEventListener("close",l),i.removeEventListener("message",h)},l=()=>{c()},h=e=>{if(c(),"string"!=typeof e.data)throw new TypeError("the first websocket message was not a text frame");const t=JSON.parse(e.data);if("open"!==t.type)throw new TypeError("message was not of open type");e.stopImmediatePropagation(),r({protocol:t.protocol,setCookies:t.setCookies}),a(s.OPEN),i.dispatchEvent(new Event("open"))};return i.addEventListener("close",l),i.addEventListener("message",h),i.addEventListener("open",t=>{t.stopImmediatePropagation(),a(s.CONNECTING),n().then(t=>s.prototype.send.call(i,JSON.stringify({type:"connect",remote:e.toString(),protocols:o,headers:t,forwardHeaders:[]})))},{once:!0}),i}async request(t,s,a,i,c,l,h){if(i.protocol.startsWith("blob:")){const t=await e(i),o=new n(t.body,t);return o.rawHeaders=Object.fromEntries(t.headers),o.rawResponse=t,o}const d={};if(s instanceof Headers)for(const[e,t]of s)d[e]=t;else for(const e in s)d[e]=s[e];const u={credentials:"omit",method:t,signal:h};"only-if-cached"!==c&&(u.cache=c),void 0!==a&&(u.body=a),void 0!==l&&(u.duplex=l),u.headers=this.createBareHeaders(i,d);const f=new o(this.http+"?cache="+(b=i.toString(),y?k?S(y,b):m(S(y,b)):k?E(b):m(E(b))),u),w=await e(f),p=await this.readBareResponse(w),g=new n(r.includes(p.status)?void 0:w.body,{status:p.status,statusText:p.statusText??void 0,headers:new Headers(p.headers)});var b,y,k;return g.rawHeaders=p.headers,g.rawResponse=w,g}async readBareResponse(e){if(!e.ok)throw new i(e.status,await e.json());const t=function(e){const t=new Headers(e),o="x-bare-headers";if(e.has(`${o}-0`)){const n=[];for(const[s,r]of e)if(s.startsWith(o)){if(!r.startsWith(";"))throw new i(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${s}`,message:"Value didn't begin with semi-colon."});n[parseInt(s.slice(15))]=r.slice(1),t.delete(s)}t.set(o,n.join(""))}return t}(e.headers),o={},n=t.get("x-bare-status");null!==n&&(o.status=parseInt(n));const s=t.get("x-bare-status-text");null!==s&&(o.statusText=s);const r=t.get("x-bare-headers");return null!==r&&(o.headers=JSON.parse(r)),o}createBareHeaders(e,t,o=[],n=[],s=[]){const r=new Headers;r.set("x-bare-url",e.toString()),r.set("x-bare-headers",JSON.stringify(t));for(const e of o)r.append("x-bare-forward-headers",e);for(const e of n)r.append("x-bare-pass-headers",e);for(const e of s)r.append("x-bare-pass-status",e.toString());return function(e){const t=new Headers(e);if(e.has("x-bare-headers")){const o=e.get("x-bare-headers");if(o.length>k){t.delete("x-bare-headers");let e=0;for(let n=0;n<o.length;n+=k){const s=o.slice(n,n+k),r=e++;t.set(`x-bare-headers-${r}`,`;${s}`)}}}}(r),r}}]];const v=Object.getOwnPropertyDescriptor(t.prototype,"readyState").get,x=["ws:","wss:"];const N=new class{manifest;client;server;working;onDemand;onDemandSignal;constructor(e,t){this.server=new URL(e),!t||t instanceof AbortSignal?(this.onDemand=!0,this.onDemandSignal=t):(this.onDemand=!1,this.loadManifest(t))}loadManifest(e){return this.manifest=e,this.client=this.getClient(),this.client}demand(){return this.onDemand?(this.working||(this.working=async function(t,o){const n=await e(t,{signal:o});if(!n.ok)throw new Error(`Unable to fetch Bare meta: ${n.status} ${await n.text()}`);return await n.json()}(this.server,this.onDemandSignal).then(e=>this.loadManifest(e)).catch(e=>{throw delete this.working,e})),this.working):this.client}getClient(){for(const[e,t]of O)if(this.manifest.versions.includes(e))return new t(this.server);throw new Error("Unable to find compatible client version. Starting from v2.0.0, @tomphttp/bare-client only supports Bare servers v3+. For more information, see https://github.com/tomphttp/bare-client/")}createWebSocket(e,o=[],n){if(!this.client)throw new TypeError("You need to wait for the client to finish fetching the manifest before creating any WebSockets. Try caching the manifest data before making this request.");try{e=new URL(e)}catch(t){throw new DOMException(`Faiiled to construct 'WebSocket': The URL '${e}' is invalid.`)}if(!x.includes(e.protocol))throw new DOMException(`Failed to construct 'WebSocket': The URL's scheme must be either 'ws' or 'wss'. '${e.protocol}' is not allowed.`);Array.isArray(o)||(o=[o]),o=o.map(String);for(const e of o)if(!C(e))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${e}' is invalid.`);const r=this.client.connect(e,o,async()=>{const t="function"==typeof n.headers?await n.headers():n.headers||{},o=t instanceof Headers?Object.fromEntries(t):t;return o.Host=e.host,o.Pragma="no-cache",o["Cache-Control"]="no-cache",o.Upgrade="websocket",o.Connection="Upgrade",o},e=>{a=e.protocol,n.setCookiesCallback&&n.setCookiesCallback(e.setCookies)},e=>{i=e},n.webSocketImpl||t);let a="",i=s.CONNECTING;const c=()=>{const e=v.call(r);return e===s.OPEN?i:e};n.readyStateHook?n.readyStateHook(r,c):Object.defineProperty(r,"readyState",{get:c,configurable:!0,enumerable:!0});const l=()=>{if(c()===s.CONNECTING)return new DOMException("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.")};n.sendErrorHook?n.sendErrorHook(r,l):r.send=function(...e){const t=l();if(t)throw t;s.prototype.send.call(this,...e)},n.urlHook?n.urlHook(r,e):Object.defineProperty(r,"url",{get:()=>e.toString(),configurable:!0,enumerable:!0});const h=()=>a;return n.protocolHook?n.protocolHook(r,h):Object.defineProperty(r,"protocol",{get:h,configurable:!0,enumerable:!0}),r}async fetch(e,t){const n=function(e){return"string"==typeof e||e instanceof URL}(e)?new o(e,t):e,s=t?.headers||n.headers,r=s instanceof Headers?Object.fromEntries(s):s;let i=new URL(n.url);const c=await this.demand();for(let e=0;;e++){"host"in r?r.host=i.host:r.Host=i.host;const o=await c.request(n.method,r,n.body,i,n.cache,n.duplex,n.signal);o.finalURL=i.toString();const s=t?.redirect||n.redirect;if(!a.includes(o.status))return o;switch(s){case"follow":{const t=o.headers.get("location");if(20>e&&null!==t){i=new URL(t,i);continue}throw new TypeError("Failed to fetch")}case"error":throw new TypeError("Failed to fetch");case"manual":return o}}}};!async function(){N.bareServer="http://localhost:8787/bare/";const e=await N.fetch("https://www.google.com/");console.log(await e.text())}()})();